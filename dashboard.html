<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Records Dashboard - Strive & Fit Tele</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Viewer Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.15/dist/docx-preview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        .dashboard-section {
            min-height: calc(100vh - 70px);
            padding-top: 90px;
            padding-bottom: 20px;
            background-color: #f8f9fa;
        }
        
        .dashboard-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 130px);
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-top {
            height: auto;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-bottom {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
        }
        
        .document-list-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        
        .document-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            min-height: 58px; /* Set a minimum height to prevent layout shifts */
        }
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }
        
        .documents-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .documents-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .total-documents, .last-update {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .documents-stats span span:last-child {
            font-weight: 600;
            color: #495057;
        }
        .search-bar {
            position: relative;
        }
        .search-input {
            padding: 8px 12px 8px 30px;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-width: 250px;
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .selection-count {
            font-size: 14px;
            color: #6c757d;
        }
        .batch-download-btn, .batch-delete-btn, .batch-process-btn {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .batch-download-btn:hover, .batch-delete-btn:hover, .batch-process-btn:hover {
            background: #f0f0f0;
        }

        .documents-table-container {
            height: 220px; /* Approx 5 rows */
            overflow-y: auto;
        }
        .documents-table {
            width: 100%;
            border-collapse: collapse;
        }
        .documents-table th, .documents-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }
        .documents-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
        }
        .documents-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .documents-table tbody tr:hover {
            background-color: #e7f3ff;
        }
        .documents-table tbody tr.selected {
            background-color: #d4edda !important;
        }
        .checkbox-cell { width: 40px; }
        .actions-cell { width: 120px; text-align: right; }
        
        .status-cell {
            width: 250px;
        }
        .processing-status {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .status-step {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .status-step.completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-step.processing {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-step.pending {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .document-actions .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #007bff;
            transition: all 0.2s ease-in-out;
        }
        .document-actions .action-btn:hover {
            color: #0056b3;
            background-color: #e7f3ff;
        }
        
        .document-viewer-panel {
            flex-grow: 1;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f1f1;
            flex-shrink: 0;
        }
        
        .user-info {
            color: #666;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 120px;
        }
        
        .upload-section:hover,
        .upload-section.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .upload-btn:hover {
            background: #0056b3;
        }
        
        .loading {
            display: none;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .viewer-title {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .viewer-actions {
            display: flex;
            gap: 10px;
        }
        
        .viewer-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .viewer-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .viewer-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .viewer-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }
        
        .viewer-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        #file-viewer {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        #pdf-canvas {
            width: 100%;
        }
        .xlsx-table {
            width: 100%;
            border-collapse: collapse;
        }
        .xlsx-table th, .xlsx-table td {
            border: 1px solid #ccc;
            padding: 8px;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <a href="index.html">
                        <img src="images/logo shape.png" alt="Strive & Fit Tele Logo Shape" class="logo-shape">
                        <img src="images/logo word.svg" alt="Strive & Fit Tele" class="logo-word">
                    </a>
                </div>
                <div class="header-actions">
                    <div class="language-dropdown">
                        <div class="selected-language">
                            <span>English</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="language-options">
                            <div class="language-option" data-lang="ENG">English</div>
                            <div class="language-option" data-lang="CHN">中文</div>
                            <div class="language-option" data-lang="ARB">العربية</div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <div>
                        <h1 data-i18n="dashboard-title">Medical Records Dashboard</h1>
                        <div class="user-info">
                            <span data-i18n="account-label">Account:</span> <span id="account-display">****-****-****-****</span>
                            <div id="debug-info" style="font-size: 12px; color: #dc3545; margin-top: 5px;"></div>
                        </div>
                    </div>
                    <a href="login.html" class="logout-btn" data-i18n="logout">Logout</a>
                </div>

                <!-- Top - Upload Section -->
                <div class="dashboard-top">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="upload-btn-main" id="upload-btn-main" data-i18n="upload-documents">Upload Documents</button>
                        <button type="button" class="cleanup-btn" id="cleanup-btn" title="Clean up storage inconsistencies" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">🧹 Cleanup</button>
                        <button type="button" class="migrate-btn" id="migrate-btn" title="Migrate old document records" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">🔄 Migrate</button>
                    </div>
                </div>

                <!-- Upload Dialog -->
                <div id="upload-dialog" class="upload-dialog">
                    <div class="upload-dialog-header">
                        <h4 data-i18n="upload-title">Upload Medical Documents</h4>
                        <button id="close-upload-dialog" class="close-btn">&times;</button>
                    </div>
                    <div class="upload-dialog-body">
                        <div id="drop-zone" class="drop-zone">
                            <p data-i18n="upload-subtitle">Drag and drop files here or click to browse</p>
                            <input type="file" id="file-input" class="file-input" accept=".pdf,.jpg,.jpeg,.png,.tiff,.gif,.bmp,.webp,.txt,.md,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.odt,.ods,.odp,.dcm,.zip,.rar,.7z" multiple>
                        </div>
                        <div id="upload-progress-container" class="upload-progress-container"></div>
                    </div>
                </div>

                <!-- Bottom - Document Display and Preview -->
                <div class="dashboard-bottom">
                    <div class="document-list-panel">
                        <div class="document-panel-header">
                            <div class="header-left">
                                <div class="documents-header-row">
                                    <h3 data-i18n="documents-title">Your Documents</h3>
                                    <div class="documents-stats">
                                        <span class="total-documents" id="total-documents">
                                            <span data-i18n="total-documents">Total:</span> 
                                            <span id="document-count">0</span>
                                        </span>
                                        <span class="last-update" id="last-update">
                                            <span data-i18n="last-update">Last update:</span> 
                                            <span id="last-update-time" data-i18n="never">Never</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="search-bar">
                                    <span class="search-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                        </svg>
                                    </span>
                                    <input type="text" id="search-input" class="search-input" data-i18n-placeholder="search-placeholder" placeholder="Search documents...">
                                </div>
                            </div>
                            <div class="header-right" id="batch-actions-container" style="display: none;">
                                <span class="selection-count" id="selection-count" data-i18n-format="selected-count" data-i18n-value="0">0 selected</span>
                                <button class="batch-download-btn" id="batch-download-btn" data-i18n-title="download-selected" title="Download Selected">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                                </button>
                                <button class="batch-delete-btn" id="batch-delete-btn" data-i18n-title="delete-selected" title="Delete Selected">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                                <button class="batch-process-btn" id="batch-process-btn" data-i18n-title="process-selected" title="Process Selected">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 96 960 960" width="18"><path d="M219 896q-21 0-35.5-14.5T169 846V330q0-21 14.5-35.5T219 281h331l-86 86H259v434h442V599l86-86v333q0 21-14.5 35.5T741 896H219Zm228-228-58-58 183-183-183-183 58-58 241 241-241 241Z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="documents-table-container">
                            <table class="documents-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-cell"><input type="checkbox" id="select-all-header-checkbox"></th>
                                        <th data-i18n="table-header-name">Name</th>
                                        <th data-i18n="table-header-date">Date Uploaded</th>
                                        <th data-i18n="table-header-status">Status</th>
                                        <th class="actions-cell" data-i18n="table-header-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documents-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                            <div class="loading" id="documents-loading" style="display: none;">
                                <p data-i18n="loading-documents">Loading documents...</p>
                            </div>
                        </div>
                    </div>
                    <div class="document-viewer-panel">
                        <div class="viewer-header">
                            <h3 class="viewer-title" id="viewer-title" data-i18n="no-document-selected">No document selected</h3>
                            <div class="viewer-actions" id="viewer-actions" style="display: none;">
                                <button class="viewer-btn active" data-view="original" data-i18n="view-original">Original</button>
                                <button class="viewer-btn" data-view="processed" data-i18n="view-processed">Processed</button>
                                <button class="viewer-btn" data-view="translated" data-i18n="view-translated">Translated</button>
                            </div>
                        </div>
                        <div class="viewer-content" id="viewer-content">
                            <div id="file-viewer"></div>
                            <div class="viewer-placeholder" style="display: none;">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                                </svg>
                                <p data-i18n="select-document-to-view">Select a document to view</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="js/language-switcher.js"></script>
    <script>
        // Global variables
        const API_BASE = '/api';
        let userCredentials = null;
        let allDocuments = [];

        // Authentication check
        function checkAuthentication() {
            // Check sessionStorage first (from login)
            let dob = sessionStorage.getItem('dob');
            let accountNumber = null;
            
            // Get account number from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            accountNumber = urlParams.get('account');
            
            // Fallback to localStorage if available
            if (!dob) {
                dob = localStorage.getItem('user_dob');
            }
            if (!accountNumber) {
                accountNumber = localStorage.getItem('user_account');
            }
            
            if (!dob || !accountNumber) {
                alert('Please log in first');
                window.location.href = 'login.html';
                return null;
            }
            
            // Store in localStorage for future use
            localStorage.setItem('user_dob', dob);
            localStorage.setItem('user_account', accountNumber);
            
            return { dob, accountNumber };
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load and display documents
        async function loadDocuments() {
            if (!userCredentials) {
                console.log('Cannot load documents: no user credentials');
                return;
            }
            
            const documentsLoading = document.getElementById('documents-loading');
            
            if (documentsLoading) {
                documentsLoading.style.display = 'block';
            }
            
            try {
                const response = await fetch(`${API_BASE}/get-documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify(userCredentials)
                });
                
                const data = await response.json();
                
                console.log('📄 get-documents response:', {
                    success: data.success,
                    documentCount: data.documents ? data.documents.length : 0,
                    documents: data.documents
                });
                
                if (data.success) {
                    allDocuments = data.documents;
                    console.log('📋 Setting allDocuments to:', allDocuments.length, 'documents');
                    displayDocuments(allDocuments);
                } else {
                    throw new Error(data.error || 'Failed to load documents');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                const tableBody = document.getElementById('documents-table-body');
                if(tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="color: #dc3545; text-align: center; padding: 20px;">Error loading documents: ${error.message}</td></tr>`;
                }
            } finally {
                if (documentsLoading) {
                    documentsLoading.style.display = 'none';
                }
            }
        }

        // Display documents in the list
        function displayDocuments(documents) {
            const tableBody = document.getElementById('documents-table-body');
            if (!tableBody) return;

            if (documents.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No documents uploaded yet</td></tr>`;
            } else {
                const sortedDocuments = documents.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                tableBody.innerHTML = sortedDocuments.map((doc, index) => {
                    const uploadDate = new Date(doc.uploadDate).toLocaleDateString();
                    
                    // Mock processing status based on index for variety
                    const statuses = [
                        { ocr: 'completed', structuring: 'completed', translation: 'completed' },
                        { ocr: 'completed', structuring: 'processing', translation: 'pending' },
                        { ocr: 'processing', structuring: 'pending', translation: 'pending' },
                        { ocr: 'pending', structuring: 'pending', translation: 'pending' },
                    ];
                    const mockStatus = statuses[index % 4];

                    return `
                        <tr data-doc-id="${doc.id}" data-doc-name="${escapeHtml(doc.originalName)}" data-mimetype="${doc.mimetype || ''}" style="cursor:pointer;">
                            <td class="checkbox-cell"><input type="checkbox" class="document-select" data-doc-id="${doc.id}"></td>
                            <td>${escapeHtml(doc.originalName)}</td>
                            <td>${uploadDate}</td>
                            <td class="status-cell">
                                <div class="processing-status">
                                    <span class="status-step ${mockStatus.ocr}">OCR</span>
                                    <span class="status-step ${mockStatus.structuring}">Structuring</span>
                                    <span class="status-step ${mockStatus.translation}">Translation</span>
                                </div>
                            </td>
                            <td class="actions-cell">
                                <div class="document-actions">
                                    <button class="action-btn process-btn" title="Process" onclick="event.stopPropagation(); processDocument('${doc.id}')"><svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 96 960 960" width="18"><path d="M219 896q-21 0-35.5-14.5T169 846V330q0-21 14.5-35.5T219 281h331l-86 86H259v434h442V599l86-86v333q0 21-14.5 35.5T741 896H219Zm228-228-58-58 183-183-183-183 58-58 241 241-241 241Z"/></svg></button>
                                    <button class="action-btn download-btn" title="Download" onclick="event.stopPropagation(); downloadDocument('${doc.id}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg></button>
                                    <button class="action-btn delete-btn" title="Delete" onclick="event.stopPropagation(); deleteDocument('${doc.id}', '${escapeHtml(doc.originalName)}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            document.querySelectorAll('.document-select').forEach(checkbox => checkbox.addEventListener('change', updateSelection));
            updateDocumentStats(documents);
            updateSelection(); // Reset selection on load
        }

        // Update document statistics in the header
        function updateDocumentStats(documents) {
            const documentCountEl = document.getElementById('document-count');
            const lastUpdateTimeEl = document.getElementById('last-update-time');
            
            if (documentCountEl) {
                documentCountEl.textContent = documents.length;
            }
            
            if (lastUpdateTimeEl) {
                if (documents.length > 0) {
                    // Find the most recent upload date
                    const mostRecent = documents.reduce((latest, doc) => {
                        const docDate = new Date(doc.uploadDate);
                        return docDate > latest ? docDate : latest;
                    }, new Date(0));
                    
                    // Format the date and time according to current language
                    const now = new Date();
                    const diffMs = now - mostRecent;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    let timeText;
                    if (diffMins < 1) {
                        timeText = 'Just now';
                    } else if (diffMins < 60) {
                        timeText = `${diffMins} min ago`;
                    } else if (diffHours < 24) {
                        timeText = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                    } else if (diffDays < 7) {
                        timeText = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                    } else {
                        timeText = mostRecent.toLocaleDateString();
                    }
                    
                    lastUpdateTimeEl.textContent = timeText;
                    lastUpdateTimeEl.removeAttribute('data-i18n');
                } else {
                    lastUpdateTimeEl.setAttribute('data-i18n', 'never');
                    lastUpdateTimeEl.textContent = 'Never';
                }
            }
        }

        async function processDocument(docId) {
            try {
                const response = await fetch(`${API_BASE}/documents/${docId}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userCredentials)
                });
                const data = await response.json();
                if (data.success) {
                    alert('Document processing started.');
                    // The backend will update the status, so we just need to refresh the list periodically
                    setTimeout(loadDocuments, 2100); // Refresh after OCR is expected to be done
                    setTimeout(loadDocuments, 4200); // Refresh after structuring is expected to be done
                    setTimeout(loadDocuments, 6300); // Refresh after translation is expected to be done
                } else {
                    throw new Error(data.error || 'Failed to start processing');
                }
            } catch (error) {
                console.error('Error starting document processing:', error);
                alert('Error starting document processing.');
            }
        }


        // Selection management
        function updateSelection() {
            const headerCheckbox = document.getElementById('select-all-header-checkbox');
            const checkboxes = document.querySelectorAll('.document-select');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            document.getElementById('selection-count').textContent = `${selectedCount} selected`;
            document.getElementById('batch-actions-container').style.display = selectedCount > 0 ? 'flex' : 'none';

            if (selectedCount === 0) {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            } else if (selectedCount === checkboxes.length) {
                headerCheckbox.checked = true;
                headerCheckbox.indeterminate = false;
            } else {
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = true;
            }

            checkboxes.forEach(checkbox => {
                checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
            });
        }

        // Download document
        async function downloadDocument(documentId) {
            if (!userCredentials) return;
            
            try {
                const response = await fetch(`${API_BASE}/download-document/${documentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify(userCredentials)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'document';
                    
                    if (contentDisposition) {
                        const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+)/);
                        const regularMatch = contentDisposition.match(/filename="(.+)"/);
                        
                        if (utf8Match) {
                            filename = decodeURIComponent(utf8Match[1]);
                        } else if (regularMatch) {
                            filename = regularMatch[1];
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Error downloading document:', error);
                alert('Error downloading document');
            }
        }

        // Delete document
        async function deleteDocument(documentId, filename) {
            if (!userCredentials) return;
            
            if (!confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                console.log('🗑️ Starting deletion for document:', documentId);
                
                const response = await fetch(`${API_BASE}/delete-document`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        ...userCredentials,
                        documentId: documentId
                    })
                });
                
                const data = await response.json();
                console.log('🗑️ Delete response:', data);
                
                if (data.success) {
                    // Update the local allDocuments array immediately
                    const originalLength = allDocuments.length;
                    allDocuments = allDocuments.filter(doc => doc.id !== documentId);
                    console.log('📋 Updated allDocuments:', originalLength, '->', allDocuments.length);
                    
                    // Update the display immediately
                    displayDocuments(allDocuments);
                    
                    // Then reload from server to ensure consistency
                    await loadDocuments();
                    
                    alert('Document deleted successfully');
                } else {
                    throw new Error(data.error || 'Delete failed');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                alert('Error deleting document: ' + error.message);
            }
        }

        // Upload files
        window.uploadFiles = async function(files) {
            if (!userCredentials || files.length === 0) return;
            
            const uploadProgressContainer = document.getElementById('upload-progress-container');
            const uploadDialog = document.getElementById('upload-dialog');
            uploadProgressContainer.innerHTML = '';
            
            let completedUploads = 0;
            const totalFiles = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = `file-${Date.now()}-${i}`;

                const progressItem = document.createElement('div');
                progressItem.className = 'progress-item';
                progressItem.id = fileId;
                progressItem.innerHTML = `
                    <div class="progress-item-info">${escapeHtml(file.name)}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill"></div>
                    </div>
                `;
                uploadProgressContainer.appendChild(progressItem);

                // Check file size and handle appropriately
                let blobUrl = null;
                let uploadMethod = 'metadata-only';
                
                // Vercel function payload limit is ~4.5MB, base64 adds ~33% overhead
                // So max file size for API upload is ~3MB
                const maxApiFileSize = 3 * 1024 * 1024; // 3MB
                
                if (file.size > maxApiFileSize) {
                    console.log(`File size ${file.size} bytes exceeds API limit, will upload directly to blob`);
                    
                    // TODO: Implement direct blob upload for large files
                    // For now, just store metadata
                    uploadMethod = 'large-file-placeholder';
                    
                } else {
                    console.log(`File size ${file.size} bytes is within API limit, uploading via API`);
                    uploadMethod = 'api-upload';
                }

                // Prepare upload data based on file size
                let uploadData;
                let fileDataBase64 = null;
                
                if (uploadMethod === 'api-upload') {
                    // Convert small files to base64 for API upload
                    try {
                        fileDataBase64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                const base64 = reader.result.split(',')[1];
                                resolve(base64);
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        console.log('File converted to base64, size:', fileDataBase64.length);
                    } catch (error) {
                        console.error('Error converting file to base64:', error);
                        fileDataBase64 = null;
                    }
                }
                
                uploadData = {
                    dob: userCredentials.dob,
                    accountNumber: userCredentials.accountNumber,
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    description: '',
                    fileDataBase64: fileDataBase64,
                    uploadMethod: uploadMethod
                };
                
                try {
                    const response = await fetch(`${API_BASE}/upload-document`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(uploadData),
                    });
                    
                    console.log('Upload response status:', response.status);
                    console.log('Upload response headers:', [...response.headers.entries()]);
                    
                    // Check if response is actually JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const textResponse = await response.text();
                        console.error('Non-JSON response received:', textResponse);
                        throw new Error(`Server returned ${contentType}: ${textResponse.substring(0, 200)}`);
                    }
                    
                    const data = await response.json();
                    console.log('Upload response data:', data);
                    
                    const progressBarFill = document.querySelector(`#${fileId} .progress-bar-fill`);

                    if (data.success) {
                        progressBarFill.style.width = '100%';
                        progressBarFill.style.backgroundColor = '#28a745';
                        
                        // Show checkmark for success
                        setTimeout(() => {
                            const progressInfo = document.querySelector(`#${fileId} .progress-item-info`);
                            progressInfo.innerHTML = `✓ ${escapeHtml(file.name)} - Uploaded successfully`;
                        }, 200);
                    } else {
                        throw new Error(data.error || 'Upload failed');
                    }
                } catch (error) {
                    const progressBarFill = document.querySelector(`#${fileId} .progress-bar-fill`);
                    const progressInfo = document.querySelector(`#${fileId} .progress-item-info`);
                    progressBarFill.style.width = '100%';
                    progressBarFill.style.backgroundColor = '#dc3545';
                    progressInfo.innerHTML = `✗ ${escapeHtml(file.name)} - Upload failed`;
                    console.error(`Error uploading ${file.name}:`, error);
                }
                
                completedUploads++;
                
                // If this is the last file, handle completion
                if (completedUploads === totalFiles) {
                    console.log('🔄 All uploads completed, refreshing document list...');
                    
                    // Refresh the document list immediately
                    try {
                        await loadDocuments();
                        console.log('✅ Document list refreshed successfully');
                    } catch (error) {
                        console.error('❌ Failed to refresh document list:', error);
                    }
                    
                    // Hide upload dialog after a short delay
                    setTimeout(() => {
                        uploadDialog.classList.remove('show');
                        uploadProgressContainer.innerHTML = '';
                    }, 2000);
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            function updatePatientInfo() {
                if (!userCredentials) return;
                const accountDisplay = document.getElementById('account-display');
                if (accountDisplay) {
                    accountDisplay.textContent = userCredentials.accountNumber.replace(/\d(?=\d{4})/g, '*');
                }
            }

            userCredentials = checkAuthentication();
            if (!userCredentials) return;

            updatePatientInfo();
            loadDocuments();

            const fileInput = document.getElementById('file-input');
            const uploadBtnMain = document.getElementById('upload-btn-main');
            const uploadDialog = document.getElementById('upload-dialog');
            const closeUploadDialog = document.getElementById('close-upload-dialog');
            const dropZone = document.getElementById('drop-zone');
            const headerCheckbox = document.getElementById('select-all-header-checkbox');
            const batchDownloadBtn = document.getElementById('batch-download-btn');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const batchProcessBtn = document.getElementById('batch-process-btn');
            const searchInput = document.getElementById('search-input');
            const cleanupBtn = document.getElementById('cleanup-btn');
            const migrateBtn = document.getElementById('migrate-btn');

            uploadBtnMain.addEventListener('click', () => uploadDialog.classList.add('show'));
            closeUploadDialog.addEventListener('click', () => uploadDialog.classList.remove('show'));
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) window.uploadFiles(e.target.files);
            });

            headerCheckbox.addEventListener('change', () => {
                document.querySelectorAll('.document-select').forEach(checkbox => {
                    checkbox.checked = headerCheckbox.checked;
                });
                updateSelection();
            });

            batchDownloadBtn.addEventListener('click', async () => {
                const documentIds = Array.from(document.querySelectorAll('.document-select:checked')).map(cb => cb.dataset.docId);
                if (documentIds.length === 0) return;
                
                try {
                    const response = await fetch(`${API_BASE}/batch-download-documents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...userCredentials, documentIds })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Medical_Documents_${new Date().toISOString().split('T')[0]}.zip`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        document.querySelectorAll('.document-select').forEach(cb => cb.checked = false);
                        updateSelection();
                    } else {
                        throw new Error('Batch download failed');
                    }
                } catch (error) {
                    console.error('Error in batch download:', error);
                    alert('Error downloading documents');
                }
            });

            batchDeleteBtn.addEventListener('click', async () => {
                const documentIds = Array.from(document.querySelectorAll('.document-select:checked')).map(cb => cb.dataset.docId);
                if (documentIds.length === 0) return;
                if (!confirm(`Are you sure you want to delete ${documentIds.length} document(s)?`)) return;
                
                try {
                    const response = await fetch(`${API_BASE}/batch-delete-documents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...userCredentials, documentIds })
                    });
                    const data = await response.json();
                    if (data.success) {
                        // Update local allDocuments array immediately
                        const originalLength = allDocuments.length;
                        allDocuments = allDocuments.filter(doc => !documentIds.includes(doc.id));
                        console.log('📋 Batch delete - Updated allDocuments:', originalLength, '->', allDocuments.length);
                        
                        // Update display immediately
                        displayDocuments(allDocuments);
                        
                        // Clear selections
                        document.querySelectorAll('.document-select').forEach(cb => cb.checked = false);
                        updateSelection();
                        
                        alert(`Successfully deleted ${data.deletedCount} document(s).`);
                        
                        // Reload from server to ensure consistency
                        await loadDocuments();
                    } else {
                        throw new Error(data.error || 'Batch delete failed');
                    }
                } catch (error) {
                    console.error('Error during batch delete:', error);
                    alert('Error deleting documents.');
                }
            });

            batchProcessBtn.addEventListener('click', async () => {
                const documentIds = Array.from(document.querySelectorAll('.document-select:checked')).map(cb => cb.dataset.docId);
                if (documentIds.length === 0) return;
                if (!confirm(`Are you sure you want to process ${documentIds.length} selected document(s)?`)) return;

                try {
                    const response = await fetch(`${API_BASE}/batch-process-documents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...userCredentials, documentIds })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Batch processing started.');
                        setTimeout(loadDocuments, 6300); // Refresh after all stages
                    } else {
                        throw new Error(data.error || 'Batch process failed');
                    }
                } catch (error) {
                    console.error('Error during batch processing:', error);
                    alert('Error processing documents.');
                }
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredDocs = allDocuments.filter(doc => doc.originalName.toLowerCase().includes(searchTerm));
                displayDocuments(filteredDocs);
            });

            // Storage cleanup functionality
            cleanupBtn.addEventListener('click', async () => {
                try {
                    cleanupBtn.disabled = true;
                    cleanupBtn.textContent = '🔄 Analyzing...';
                    
                    // First, analyze storage
                    const analysisResponse = await fetch(`${API_BASE}/cleanup-storage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userCredentials)
                    });
                    
                    const analysisData = await analysisResponse.json();
                    
                    if (analysisData.success) {
                        const analysis = analysisData.analysis;
                        let message = `Storage Analysis:\n\n`;
                        message += `• Total documents: ${analysis.totalDocuments}\n`;
                        message += `• Documents with files: ${analysis.documentsWithBlobs}\n`;
                        message += `• Total blob files: ${analysis.totalBlobs}\n`;
                        message += `• Orphaned files: ${analysis.orphanedBlobs}\n`;
                        message += `• Broken metadata: ${analysis.brokenMetadata}\n\n`;
                        
                        if (analysis.orphanedBlobs > 0 || analysis.brokenMetadata > 0) {
                            message += `Issues found! Click OK to run cleanup.`;
                            
                            if (confirm(message)) {
                                cleanupBtn.textContent = '🧹 Cleaning...';
                                
                                const cleanupResponse = await fetch(`${API_BASE}/cleanup-storage`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        ...userCredentials,
                                        action: 'cleanup'
                                    })
                                });
                                
                                const cleanupData = await cleanupResponse.json();
                                
                                if (cleanupData.success) {
                                    const results = cleanupData.cleanupResults;
                                    alert(`Cleanup completed!\n\n• Orphaned files deleted: ${results.orphanedBlobsDeleted}\n• Broken metadata fixed: ${results.brokenMetadataFixed}\n• Errors: ${results.errors.length}`);
                                    
                                    // Refresh document list
                                    await loadDocuments();
                                } else {
                                    throw new Error(cleanupData.error || 'Cleanup failed');
                                }
                            }
                        } else {
                            alert(message + 'Storage is clean and consistent!');
                        }
                    } else {
                        throw new Error(analysisData.error || 'Analysis failed');
                    }
                } catch (error) {
                    console.error('Error during cleanup:', error);
                    alert('Error during cleanup: ' + error.message);
                } finally {
                    cleanupBtn.disabled = false;
                    cleanupBtn.textContent = '🧹 Cleanup';
                }
            });

            // Document migration functionality
            migrateBtn.addEventListener('click', async () => {
                try {
                    migrateBtn.disabled = true;
                    migrateBtn.textContent = '🔄 Migrating...';
                    
                    const response = await fetch(`${API_BASE}/migrate-documents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userCredentials)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const stats = data.stats;
                        alert(`Migration completed!\n\n• Total documents: ${stats.totalDocuments}\n• Migrated: ${stats.migratedDocuments}\n• Already up-to-date: ${stats.alreadyMigrated}`);
                        
                        // Refresh document list
                        await loadDocuments();
                    } else {
                        throw new Error(data.error || 'Migration failed');
                    }
                } catch (error) {
                    console.error('Error during migration:', error);
                    alert('Error during migration: ' + error.message);
                } finally {
                    migrateBtn.disabled = false;
                    migrateBtn.textContent = '🔄 Migrate';
                }
            });

            const tableBody = document.getElementById('documents-table-body');
            tableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.docId) {
                    // Don't trigger if clicking a button or checkbox
                    if (e.target.closest('button') || e.target.matches('input[type="checkbox"]')) {
                        return;
                    }
                    const { docId, docName, mimetype } = row.dataset;
                    viewDocument(docId, docName, mimetype);
                }
            });

            // Drag and drop setup
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                document.body.addEventListener(eventName, () => {
                    uploadDialog.classList.add('show');
                    dropZone.classList.add('dragover');
                });
            });
            document.body.addEventListener('dragleave', e => {
                if (!e.relatedTarget || !document.body.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });
            document.body.addEventListener('drop', e => {
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) window.uploadFiles(e.dataTransfer.files);
            });
        });

        async function viewDocument(docId, docName, mimetype, version = 'translated') {
            const viewer = document.getElementById('file-viewer');
            const viewerTitle = document.getElementById('viewer-title');
            const viewerActions = document.getElementById('viewer-actions');
            
            viewerTitle.textContent = docName;
            viewer.innerHTML = '<p>Loading preview...</p>';
            viewerActions.style.display = 'flex';

            // Update active button
            viewerActions.querySelectorAll('.viewer-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === version);
            });

            try {
                const response = await fetch(`${API_BASE}/view-document/${docId}/${version}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userCredentials)
                });
                
                if (!response.ok) {
                    if (version !== 'original') {
                        // Fallback to original if translated/processed not found
                        viewDocument(docId, docName, mimetype, 'original');
                        return;
                    }
                    throw new Error('Failed to load document preview.');
                }

                const data = await response.json();
                
                if (data.success) {
                    if (data.redirectUrl) {
                        // For original files, show the blob URL content
                        if (data.contentType.startsWith('image/')) {
                            viewer.innerHTML = `<img src="${data.redirectUrl}" alt="${data.documentName}" style="max-width: 100%; height: auto;">`;
                        } else if (data.contentType === 'application/pdf') {
                            viewer.innerHTML = `<iframe src="${data.redirectUrl}" style="width: 100%; height: 600px; border: none;"></iframe>`;
                        } else {
                            viewer.innerHTML = `<p>Document: <a href="${data.redirectUrl}" target="_blank">${data.documentName}</a></p>`;
                        }
                    } else if (data.content) {
                        // For processed/translated content, render as markdown
                        viewer.innerHTML = `<div style="padding: 20px; white-space: pre-wrap; font-family: monospace;">${escapeHtml(data.content)}</div>`;
                    }
                } else {
                    throw new Error(data.error || 'Failed to load document');
                }

            } catch (error) {
                console.error('Error loading document preview:', error);
                viewer.innerHTML = `<p style="color:red;">Error loading preview: ${error.message}</p>`;
            }
        }

        // Add event listeners to viewer buttons
        document.getElementById('viewer-actions').addEventListener('click', (e) => {
            if (e.target.matches('.viewer-btn')) {
                const version = e.target.dataset.view;
                const docId = document.querySelector('.document-item.active')?.dataset.docId;
                const docName = document.querySelector('.document-item.active')?.dataset.docName;
                const mimetype = document.querySelector('.document-item.active')?.dataset.mimetype;
                if (docId) {
                    viewDocument(docId, docName, mimetype, version);
                }
            }
        });

        function renderFile(container, blob, mimetype, fileName) {
            container.innerHTML = ''; // Clear previous content
            const extension = fileName.split('.').pop().toLowerCase();

            if (mimetype.startsWith('image/')) {
                const url = URL.createObjectURL(blob);
                container.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 100%;" onload="URL.revokeObjectURL(this.src)">`;
            } else if (mimetype === 'application/pdf') {
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                renderPdf(canvas, blob);
            } else if (mimetype === 'text/markdown' || extension === 'md') {
                blob.text().then(text => {
                    container.innerHTML = marked.parse(text);
                });
            } else if (mimetype.includes('spreadsheet') || mimetype.includes('excel') || extension === 'xlsx') {
                renderXlsx(container, blob);
            } else if (mimetype.includes('wordprocessingml.document') || extension === 'docx') {
                docx.renderAsync(blob, container);
            } else if (mimetype.startsWith('text/')) {
                blob.text().then(text => {
                    const pre = document.createElement('pre');
                    pre.textContent = text;
                    container.appendChild(pre);
                });
            } else {
                container.innerHTML = `<p>Preview for this file type (${mimetype}) is not available.</p>`;
            }
        }

        async function renderPdf(canvas, blob) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
            const data = await blob.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data }).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.5 });
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;
        }

        function renderXlsx(container, blob) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const html = XLSX.utils.sheet_to_html(worksheet);
                container.innerHTML = `<table class="xlsx-table">${html}</table>`;
            };
            reader.readAsArrayBuffer(blob);
        }
    </script>
</body>
</html>